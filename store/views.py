from django.shortcuts import render, get_object_or_404, redirect
from django.contrib import messages
from .models import Product, Category


# ğŸ›ï¸ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±
def product_list(request):
    """
    ğŸ›ï¸ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØµÙØ­ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
    """
    # âœ… Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¨Ø¬Ø¯ÙŠ
    categories = Category.objects.all().order_by('name')

    # âœ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø±ØªØ¨Ø© Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«
    products = Product.objects.all().order_by('-created_at')

    # ğŸŸ¡ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if not products.exists():
        messages.info(request, "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’")

    # âœ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù‚Ø§Ù„Ø¨
    context = {
        "products": products,
        "categories": categories,
        "selected_category": None,
    }
    return render(request, "store-templates/product_list.html", context)


# ğŸ§­ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ
def product_list_by_category(request, category_id):
    """
    ğŸ§­ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø°ÙŠ Ø§Ø®ØªØ§Ø±Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    """
    # ğŸ”¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø£Ùˆ Ø¹Ø±Ø¶ 404
    category = get_object_or_404(Category, id=category_id)

    # ğŸ”¹ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ ÙÙ‚Ø·
    products = Product.objects.filter(category=category).order_by('-created_at')

    # ğŸ”¹ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    categories = Category.objects.all().order_by('name')

    # âš ï¸ ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ
    if not products.exists():
        messages.warning(request, f"ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¶Ù…Ù† ØªØµÙ†ÙŠÙ: {category.name}")

    # âœ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨
    context = {
        "products": products,
        "categories": categories,
        "selected_category": category,
    }
    return render(request, "store-templates/product_list.html", context)


# ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
def add_to_cart(request, product_id):
    """
    ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ session
    """
    product = get_object_or_404(Product, id=product_id)
    cart = request.session.get('cart', {})

    # ğŸ”¹ Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø³Ù„Ø©ØŒ Ø²ÙØ¯ Ø§Ù„ÙƒÙ…ÙŠØ©
    if str(product_id) in cart:
        cart[str(product_id)]['quantity'] += 1
    else:
        # ğŸ”¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³Ù„Ø©
        cart[str(product_id)] = {
            'name': product.name,
            'price': float(product.price),
            'quantity': 1,
        }

    # ğŸ”¹ Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
    request.session['cart'] = cart

    messages.success(request, f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {product.name} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ›ï¸")
    return redirect('store:product_list')


# ğŸ§¾ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„Ø©
def cart_detail(request):
    """
    ğŸ§¾ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    """
    cart = request.session.get('cart', {})
    total = sum(item['price'] * item['quantity'] for item in cart.values())

    context = {
        'cart': cart,
        'total': round(total, 2),
    }
    return render(request, 'store-templates/cart_detail.html', context)
